<!DOCTYPE html>
<html style="height:100%">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>drag-rectange</title>
    <link rel="stylesheet" type="text/css" href="./index.css">
    <style type="text/css">
        :root{
            --palette-width: 250px;
        }

        input[type=range]{ 
                 
                outline: none; 
                -webkit-appearance: none;/*清除系统默认样式*/  
                width:56% !important;  
                background: -webkit-linear-gradient(#61bd12, #61bd12) no-repeat, #ddd;  
                background-size: 30% 100%;/*设置左右宽度比例*/  
                height: 3px;/*横条的高度*/  
        } 
        input[type=range] {
            -webkit-appearance: none;
            width: 300px;
            border-radius: 10px; /*这个属性设置使填充进度条时的图形为圆角*/
        }
        
        input[type=range]::-webkit-slider-thumb {  
             -webkit-appearance: none;/*清除系统默认样式*/  
            height:16px;/*拖动块高度*/  
                width: 16px;/*拖动块宽度*/  
                background: #fff;/*拖动块背景*/  
            border-radius: 50%; /*外观设置为圆形*/  
             border: solid 1px #ddd; /*设置边框*/  
        }
        input[type=range]:focus {
            outline: none;
        }

        div,textarea{
            box-sizing: border-box;
        }
        ul li{
            text-align: center;
            margin-bottom:0.8em;
        }
        a{
            text-decoration: none;
            cursor:pointer;
            display: inline-block;min-width: 1.2em;
            user-select: none;
        }
        a:active i{
             font-size:0.9em;
        }
        #img-tool,#txt-tool,#align-tool{
            width:100%;
            top:300px;
            -webkit-transform:translateY(-70px);
            opacity: 0.2;
            position:absolute;
            height: 0;
            overflow: hidden;
            transition:height 0.5s cubic-bezier(0.42,0,1,1),transform 0.4s cubic-bezier(0.42,0,1,1),opacity 0.5s cubic-bezier(0.42,0,1,1);
        }
        #delete-tool{
            width:100%;
            position:absolute;
            bottom:0px;
        }
       /* #txt-tool{
            top:450px;
        }*/
        
        .text-clip{
            -webkit-background-clip: text;
            color:transparent;
        }
        .text-bottom-gradient{
            background:linear-gradient(to top, var(--green),var(--orange) 15%, #fff 20%, #fff);
            -webkit-background-clip: text;
            color:transparent;
        }
        input[type='number']{
            display: inline-block;
            width:50px;
           
        }
        .text-center{
             text-align: center;
        }
        .canvas-content{
            background-color: #f5fcff;
        }
        .absolute-center{
            position:absolute;left:50%;top:50%;
            transform: translate(-50%,-50%);
        }
        .bgi-normal{
            background-size: 100% 100%;
            background-position: center center;
            background-repeat: no-repeat;
        }
        .bgi-center{
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
        }
        .tool-bar[data-current='img'] #img-tool{
            display: block;
            height:200px;
            opacity: 1;
             -webkit-transform:translateY(0px);
        }
        .tool-bar[data-current='align'] #align-tool{
            display: block;
            height:250px;
            opacity: 1;
             -webkit-transform:translateY(0px);
        }

        .tool-bar[data-current='txt'] #txt-tool{
            display: block;
            height:200px;
            opacity: 1;
             -webkit-transform:translateY(0px);
        }
        .tool-bar[data-current='txt'] + .left,.tool-bar[data-current='image-var'] + .left{
            margin-right:350px;
        }
        .tool-bar[data-current='image-var'] + .left .imgVar-palette{
            z-index: 999;
        }
        .left{
           transition:left .3s cubic-bezier(0.42,0,1,1),margin .3s cubic-bezier(0.42,0,1,1);
           box-sizing: content-box;
           left:0;
           margin-right:100px;
           margin-left:0;
        }
        .focus-ele{
            outline: var(--assertive) 1px dashed;
        }
        .group-ele{
            outline: var(--blue) 1px dashed;
        }
        .txt-palette,.imgVar-palette{
            width:var(--palette-width);
            box-sizing: border-box;
            border-right:var(--gray-800) 2px solid;
        }
        .txt-palette{
            z-index:99;
        }
        .imgVar-palette{
            z-index:9;
        }
        .txt-palette .txt-text{
            background-color: var(--gray-900);
            color:var(--light);

            border:none;
            border-bottom:2px var(--black) solid;
            font-size: 20px;line-height: 1;height:100px;
        }
        .txt-palette ul li,.imgVar-palette ul li{
            height: 50px;
            line-height: 50px;
            vertical-align: center;
            padding:10px 20px;
            margin:0;
            border-bottom:2px var(--black) solid;
            text-align: left;
            white-space: nowrap;
        }
        .txt-palette ul li span,.imgVar-palette ul li span{
            line-height: 25px;

        }
        .txt-palette ul li input,.imgVar-palette ul li input{
            width:120px;
            transform:translateY(-5px);
        }
        .link-palette[data-type='img'] li[data-type='txt']{
            display: none;
        }
        .link-palette[data-type='txt'] li[data-type='img']{
            display: none;
        }
        .real-view{
            transform:scale(0.3779) translate(-50%,-50%);
            transform-origin:left top;
        }
    </style>
</head>

<body class='p-0 m-0 h-100  position-relative' style='overflow:hidden;background-color:#071937'>
    
    <div class='tool-bar m-0 h-100 bg-black position-absolute' style='width:100px;right:0;top:0;box-sizing: border-box;overflow:hidden;z-index:9999;' data-current=''>
        <ul id='main-tool' class='pt-4 border-bottom border-gray-900' style='font-size: 30px;'>
            <li>
                <a class='add-img' data-href='img' style='overflow:hidden;'>
                    <i class='iconfont text-white'>&#xe610;</i>
                    <input type="file" name="img-select" accept="image/*" class='position-absolute' style='opacity:0;width:0;height:0'/>
                </a>
            </li>
            <li>
                <a class='add-txt' data-href='txt'><i class='iconfont text-white'>&#xe89b;</i></a>
            </li>
            <li>
                <a class='add-linkImg'><i class='iconfont text-white'>&#xe621;</i></a>
            </li>
            <li>
                <a class='add-bgImg'>
                    <i class='iconfont text-white'>&#xe77f;</i>
                    <input type="file" name="bgImg-select" accept="image/*" class='position-absolute' style='opacity:0;width:0;height:0'/>
                </a>
            </li>
            
        </ul>
        <ul id='img-tool' style='font-size: 30px;'>
            <li>
                <a class='img-scale' data-type='plus'><i class='iconfont text-white'>&#xe6f6;</i></a>
            </li>
            <li>
                <a class='img-scale' data-type='minus'><i class='iconfont text-white'>&#xe794;</i></a>
            </li>

        </ul>
        <ul id='txt-tool' style='font-size: 30px;'>
            <li>
                <a class='txt-plus'><i class='iconfont text-white'>&#xe635;</i></a>
            </li>
            <li>
                <a class='txt-minus'><i class='iconfont text-white'>&#xe633;</i></a>
            </li>
            <li>
                <a class='txt-color'>
                    <i class='iconfont text-bottom-gradient text-clip '>&#xe60f;</i>
                    <input type="color" name="color-select" accept="image/*" class='position-absolute' style='opacity:0;width:0;height:0'/>
                </a>
            </li>
        </ul>
        <ul id='align-tool' style='font-size: 30px;'>
            <li>
                <a class='align-left'><i class='iconfont text-white'>&#xe65d;</i></a>
            </li>
            <li>
                <a class='align-right'><i class='iconfont text-white'>&#xe603;</i></a>
            </li>
            <li>
                <a class='align-top'><i class='iconfont text-white'>&#xe605;</i></a>
            </li>
            <li>
                <a class='align-bottom'><i class='iconfont text-white'>&#xe607;</i></a>
            </li>
            
        </ul>
        <ul id='delete-tool' class='pt-4 border-top border-gray-900' style='font-size: 30px;'>
            
            <li>
                <a class='ele-layer' data-type='low'>
                    <i class='iconfont text-white'>&#xe638;</i>
                </a>
            </li>
            <li>
                <a class='bg-delete'><i class='iconfont text-white'>&#xe601;</i></a>
            </li>
            <li>
                <a class='ele-delete'><i class='iconfont text-white'>&#xe616;</i></a>
            </li>
        </ul>
    </div>
    <div class='left h-100  position-relative' style='background-color: #071937;background-image: url("./dot.png")'>
        <p class='main-title m-0 text-center text-white' style="font-size: 1.4em;font-weight: 600;"></p>
        <p class='m-0 text-center text-white'>
            画布尺寸: 宽 <input type="number" disabled name="width" value="856" />×
            高 <input type="number" name="height" disabled value='539.8'/>
            <a class='shuffer-canvas btn btn-main shadow px-2 py-1 m-1'>切换视图</a>
            <!-- <a class='iconfont radius-plus text-white btn btn-main shadow rounded-lg p-1 m-1' style='font-size: 1.8em'>&#xe6a1;</a>
            <a class='iconfont radius-minus text-white btn btn-main shadow rounded-sm p-1 m-1' style='font-size: 1.8em'>&#xe604;</a> -->

        </p>
        <div class="canvas-container bgi-normal absolute-center"  style="text-align:center;">
            
        </div>
        <div class="canvas-content bgi-normal absolute-center"  style="text-align:center;">
            
        </div>

        <p class='tip-info position-absolute text-white m-0'
        style='bottom:50px;line-height: 1.5;left:50%;transform:translateX(-50%)'>
            1.   比例尺 显示尺寸  100px = 1mm  实际尺寸<br/>
            2.   按住 ctrl 键选择多个元素进行排列对齐<br/>
            3.   按住 ctrl + ↑→↓← 键进行位置的微调
        </p>
        <p class='position-info bg-black position-absolute text-white m-0'
        style='bottom:2px;line-height: 1.14;'></p>
        <div class='imgVar-palette position-absolute bg-gray-900' style='left:100%;top:0;height:100%;'>
            
            <ul class='text-white'>
               <li>
                    宽度
                    <input class='imgVar-width' type='range' id="rotateRatio" min='0' max='5' step='0.1'/>
                    <span class='imgVar-width-info'></span>
                </li> 
               <li> 
                    高度
                    <input class='imgVar-height' type='range' id="rotateRatio" min='0' max='5' step='0.1'/>
                    <span class='imgVar-height-info'></span>
                </li>
            </ul>
        </div>
        <div class='txt-palette position-absolute bg-gray-900' style='left:100%;top:0;height:100%;'>
            <textarea class='txt-text w-100 ' >
                
            </textarea>
            
            <ul class=' text-white'>
               <li>
                    宽度
                    <input class='txt-width' type='range' id="rotateRatio" min='0' max='5' step='0.1'/>
                    <span class='txt-width-info'></span>
                </li> 
               <li> 
                    高度
                    <input class='txt-height' type='range' id="rotateRatio" min='0' max='5' step='0.1'/>
                    <span class='txt-height-info'></span>
                </li>
                <li> 
                    行高
                    <input class='txt-lineHeight' type='range' id="rotateRatio" min='0' max='5' step='0.1'/>
                    <span class='txt-lineHeight-info'></span>
                </li>
                <li> 
                    磅数
                    <input class='txt-fontWeight' type='range' id="rotateRatio" min='100' max='900' step='100'/>
                    <span class='txt-fontWeight-info'></span>
                </li> 
                <li> 
                    字体
                    <select class='txt-fontFamily' style='font-size: 18px;width:150px;margin-left:10px'/></select>
                </li> 
                
                <li class='border-0 position-absolute w-100 ' style="text-align: center;padding: 0;bottom:50px">
                    <a class='link-txt'><i class='iconfont text-white'>&#xe62a;</i> 链接动态文字</a>
                </li>
            </ul>
        </div>
    </div>
    <div class='fake-dom position-absolute' style='top:0;left:0;width:200px;height:200px;z-index:-999;opacity:0;'>
        <!-- <img src='' class='fake-img' style='position:absolue;opacity:0;z-index:-999' /> -->
    </div>
    <div class="link-palette absolute-center bg-gray-900 shadow-lg text-white" style='overflow:auto;max-height:800px;width: 400px;z-index:999;display:none;' data-type=''>
        <p class='text-center my-2' style="font-size: 22px">
            请选择填充内容
        </p> 
        <ul class='position-relative px-4  text-white' style='font-size: 25px;'>
            
        </ul>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="./jquery.panzoom.js"></script>
    <script src="font-ch-en.js" type="text/javascript" charset="utf-8"></script>
    <script src="d3.js" type="text/javascript" charset="utf-8"></script>
    <script src="isSupportFontFamily.js" type="text/javascript" charset="utf-8"></script>
    <script src="../dist/result.js" type="text/javascript" charset="utf-8"></script>
    <script>
        var arrFont = dataFont['windows'];
        const supportFontFamily = []
        arrFont.forEach(function (obj) {
            let  fontFamily = obj.en
            if(isSupportFontFamily(fontFamily)){
                supportFontFamily.push(obj)
            }
        });
    </script>
    <script type="text/javascript">
        var linkDic = [{
            type:'txt',
            key:'userName',
        },{
            type:'txt',
            key:'location',
        },{
            type:'img',
            key:'userAvatar',
        },{
            type:'txt',
            key:'userName',
        },{
            type:'txt',
            key:'location',
        },{
            type:'img',
            key:'userAvatar',
        },{
            type:'txt',
            key:'userName',
        },{
            type:'txt',
            key:'location',
        },{
            type:'img',
            key:'userAvatar',
        },{
            type:'img',
            key:'logo'
        }]
        // 最终的对象集合
        const elementArr = []
        var elementGroup = new Set()
        var currentElement; 
        
        // Regex
        
        var floating = '(\\-?\\d[\\d\\.e-]*)';
        var commaSpace = '\\,?\\s*';
        var rmatrix = new RegExp(
            '^matrix\\(' +
            floating + commaSpace +
            floating + commaSpace +
            floating + commaSpace +
            floating + commaSpace +
            floating + commaSpace +
            floating + '\\)$'
        );
        const getMatrix = function(transform) {
            var matrix = rmatrix.exec(transform);
            if (matrix) {
                matrix.shift();
            }
            return matrix || [ 1, 0, 0, 1, 0, 0 ];
        }
        function getBase64Image(img,width,height) {  
             var canvas = document.createElement("canvas");  
             var ctx = canvas.getContext("2d");  
             ctx.drawImage(img, 0, 0, width, height);  
             var ext = img.src.substring(img.src.lastIndexOf(".")+1).toLowerCase();  
             var dataURL = canvas.toDataURL("image/"+ext);  
             return dataURL;  
        }  
        class ele{
            focus(){
               currentElement = this;
               this.dom && this.dom.addClass('focus-ele')

               this.dom && $('.tool-bar').attr('data-current',this.type)
               if(this.type== 'txt'){
                 $('.txt-palette').find('.txt-text').val(this.text.replace(/&nbsp;/g,' ').replace(/<br\/>/g,'\n')).end()   
                 .find('.txt-height').val(this.height).trigger('change').end()
                 .find('.txt-height-info').text(this.height).end()
                 .find('.txt-width').val(this.width).trigger('change').end()
                 .find('.txt-width-info').text(this.width).end()
                 .find('.txt-lineHeight').val(this.lineHeight).trigger('change').end()
                 .find('.txt-lineHeight-info').text(this.lineHeight).end()
                 .find('.txt-fontWeight').val(this.fontWeight).trigger('change').end()
                 .find('.txt-fontWeight-info').text(this.fontWeight).end()
                 .find('.txt-fontFamily').val(this.fontFamily).end()

               }
               if(this.type == 'image-var'){
                    $('.imgVar-palette').find('.imgVar-text').val(this.text).end()   
                    .find('.imgVar-height').val(this.height).trigger('change').end()
                    .find('.imgVar-height-info').text(this.height).end()
                    .find('.imgVar-width').val(this.width).trigger('change').end()
                    .find('.imgVar-width-info').text(this.width).end()
               }
            }
            remove(){
                let index = elementArr.indexOf(this)
                elementArr.splice(index,1)
                this.dom && this.dom.remove();
                currentElement = null;
                $('.tool-bar').attr('data-current','')
            }
            toLayerBottom(){
                let index = elementArr.indexOf(this)
                // 将这个元素提到最前
                elementArr.splice(0,0,elementArr.splice(index,1)[0])
                elementArr.map((item,index)=>{
                    item.zIndex = (index+1)*100
                })
            }
            link(key){
                let link = linkDic.find(item => item.key==key)

                this.linkType = link.type
                this.linkKey = link.key 
                console.log(link)
                this.text += '${'+link.key+'}'
                $('.txt-palette').find('.txt-text').val(this.text)
            }
            blur(){
                this.dom && this.dom.removeClass('focus-ele').removeClass('group-ele')
            }
            getMatrix(){
                return getMatrix(this.dom.css('transform'))
            }
            getDimension(){
                let matrix =this.getMatrix()
                return {
                    x : this.width * (1 - matrix[0])/2 + Number(matrix[4]),
                    y : this.height * (1 - matrix[3])/2 + Number(matrix[5]),
                    width:this.width * matrix[0],
                    height:this.height * matrix[3],
                }
            }
            
            serialize(){
                return Object.assign({
                    elementType:this.type=="image-var"?"image-var":this.type=='txt'?"text":this.type=='img'?"image":'',
                    type:this.type,
                    backgroundImg:this.url,
                    value:this.text,
                    src:this.src,
                    fontSize:this.fontSize,
                    fontFamily:this.fontFamily,
                    lineHeight:this.lineHeight,
                    fontWeight:this.fontWeight,
                    zIndex:this.zIndex,
                    color:this.color

                },this.getDimension())
            }
            handleClick(e){
                if(e.ctrlKey){
                    let crt_ele = currentElement 
                    setCurrent(null)
                    // 当前元素 不是 点击的元素
                    if(crt_ele && crt_ele !== this ){
                        crt_ele.dom.toggleClass('group-ele')
                        elementGroup.has(crt_ele)?elementGroup.delete(crt_ele):elementGroup.add(crt_ele)
                    }

                    this.dom.toggleClass('group-ele')
                    elementGroup.has(this)?elementGroup.delete(this):elementGroup.add(this)
                        
                    
                    
                    elementGroup.size>0?$('.tool-bar').attr('data-current','align'):$('.tool-bar').attr('data-current','')
                }else{
                    elementGroup = new Set()
                    setCurrent(this)
                }
            }
            set zIndex(val){
                this.dom && this.dom.css('z-index',val)
                this._zIndex = val
            }
            get zIndex(){
                let index = elementArr.indexOf(this)>-1?elementArr.indexOf(this) + 1:elementArr.length
                this._zIndex = index*100
                return this._zIndex;
            }
            set text(val){
                this.dom && this.dom.html(val)
                this._text = val

            }
            get text(){
                return this._text
            }
        }

        class Img extends ele {
            constructor(url='',width=200,height=200,maxScale=1.5){
                super()
                this.type = 'img'
                this.url = url
                this.width = width
                this.height = height
                this.maxScale = maxScale
                this.init()
            }
            init(){
                let that = this
                this.dom = $(`<div class='bgi-normal position-absolute ' style='background-image:url(${this.url})'> </div>`)
                    .css('width',this.width).css('height',this.height)
                    .css('z-index',this.zIndex)
                    .on('click',function(e){
                        that.handleClick(e)
                       
                    })
                this.dom.appendTo($('.canvas-content'))
                this.pz = this.dom.panzoom({
                    startTransform: 'scale(1)',
                      maxScale: this.maxScale,
                      increment: 0.05,
                      contain:true,
                      minScale: 0.4,
                      disableZoom: false
                })
                
            }
        }
        class ImageVar extends ele{
            constructor(url,width=200,height=200,maxW,maxH){
                super()
                this.type = 'image-var'
                this.text = url
                this.src = url
                this.width = width
                this.height = height
                this.maxW = maxW
                this.maxH = maxH
                this.init()
            }
            init(){
                let that = this
                this.dom = $(`<div class='bgi-normal position-absolute ' style='background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAASEUlEQVR4Xu2df3Bc1XXHv+etJNvYsvdtgECKMZa1a5uQlpSZkISh5UdaCKSFuoYpMEMafhnvChog9QAZOqbjhBASNyHadZVgMgMDaTAMpAFSGigdoKHJhEChJLBPsiCAG2zYXVnG2NLuO50nkGMLWb4rvbf7pPvdv+yZc+8953PuZ1Zv9727gnpfd/xubmrH4HkKrIDiCAFcCFIADqp3KsaTQGQEVN8BpKyiJSheV8G9lXnz78GFh71Tz5piGpzc4H1cfHxRBOcCmG06jnEkECMCu6D6L+on1pevWPKCSV4HFCRV8D4JYC2A00wmZAwJTAcCCn3QdxI3Dly+5JcT5bt/Qe7RhLut91si6JoOBTNHEpgMAVV8rZztvB4iOt748QXZ+FK7uzvxYwH+dDKLcgwJTCcCqvpwefeclbh64btj8/6gIPmt81wZeFqAY6ZTkcyVBKZGQH9RymaOP6AgbsF7WIDPTm0xjiaB6UdAgbvL2fQFe2e+zzuImy+uE5EvT7/SmDEJhERAcXUpl/6n0dn2CJLMF491RJ4NaRlOQwLTkoACNfUTSypdHa8GBewRJFXwngYQfKTLFwnYTUD1/lIus2KPIAvy3sqEYJPdVFg9CexFwMenS13p4MMqwC14TwlwAgGRAAm8T0BxbymXPkfm3/ZaKjG06y3Z688tQiIBEsDOUqIzKckN3kWOYiOBkAAJjCEgOF3cvPfD929AJB8SIIF9LkOwPhDkZyL4FMmQAAnsS0AVPwoE8UTQSTgkQAIfIPCMuAWvIsACwiEBEhhDQPGmpAreuLf5EhYJkABAQbgLSGACAk0TRBV3qeAeqTn9Q7Nl6zuXdrzJTpHAKIG539v84bZdeqgm/MWiOFcE+9xl2yhSDRVEFdsEuKk0u3YbLl422Kgiuc4MILDxpfbU7sSlqnq9iHyoURU1TBBVXFfePfvb4z211ahiuc4MINCz5aBkdcc1jsg/NqKayAVR1bdrijO3d2V+3oiCuIYdBBZ0953qOP6mkWOnInxFKogCZb/WetzAFUf1R1gDp7aUQHth89JWrT4DkblRIYhMEFX4kMRJ5WzHk1Elz3lJwO3uO0Mc/6GoSEQmiA+9oZLNrIsqcc5LAqMEknnvG47gmiiIRCSIvlHamj4Ka6UaRdKckwT2JpC61ZuvLdovkOAI3FBfkQjiq3y+kuu8I9RMORkJTEAglfeugmB92JDCF0SxvbSt08Va8cNOlvORwH4JrH9tjjv73YpA2sKkFLogqrijnEt/PswkORcJmBBw895PRHC6SaxpTOiC+CIrKqs77zdNgHEkEBYBd4O3WhSFsOYL5gldEPg4ptSVfjHMJDkXCZgQcAubTxTUnjCJNY0JXZDhhH/I4Kqlb5kmwDgSCItAKt+7EKK/DWu+SN5BStn0AX9zJMwCOBcJ7E0g7OebQn8HoSDcsM0k4Ba8qgCJsHKgIGGR5DyxIEBBYtEGJhFXAhQkrp1hXrEgQEFi0QYmEVcCFMSwM+09Lx/cOuyc4gs+4UAXq8hiAB0jwzW4sQ39KugTdX5ZnTXrp9svWVgynJphMSZAQSZozkE9rxw+qzp8JWTkJ6uPNT2QW4Hg6KPnoPrw7pa2/M5VR/1fjPcAU5uAAAUZB04gxuzq0LUKWSWCWVPcQbug0jPk4Ks7VnduneJcHN5gAhRkDPDgNmcFbgpBjLGt3OUD11Wy6W81uMdcbgoEKMgovLXakjq097sAvjAFniZDv1/a2nkZH/4yQdX8GAoCYEHhVdfB0IMCfLoRLVHgZz7aPjeQXVRuxHpcY/IEKMg9mnC39T7Z6J9sUNWnyoekT8K5Upt8+zgyagLWC5IqeLc34M+qcfuoikI5l85F3WTOP3kCVgvi5nu7RPQ7k8cXxkhZVcp2Btc+fMWQgLWCzM33H9Ymw6+G/cxxvT1W6NDuRNtR/K6kXnKNibdWELfQu0GglzcG88SrqKK7nEtfEYdcmMO+BKwUJHhSTGXk9pDQ7vOfysbiu8hU6EU71kpBkgXvmw5wdbRo65vdV3yzkkt/qb5RjI6agJWCuIVicGreUVHDrWd+Ve0v5zLv3fzIV2wIWCdI6p+9o+EjlqekDKkevSOX+U1sdgcTgXWCuHnvWhHcFMfeK3BtOZu+OY652ZqTdYKk8t4mCFbGtOGbStn0uTHNzcq0rBPELXhPCXBCHLut0CfL2cyfxDE3W3OyUJBin0DiejHslbLpjK2bMY512ydIvjgsIi1xbAagg6VsZn48c7MzK+sESeWLgxCZF8t2q+4o5TLtsczN0qTsE6TgFQGkY9lvRbGUSy+NZW6WJmWdIG6h+IRAToxjvxX4z3I2fXIcc7M1J/sEyXs/FEEsP0pV1R+Uc5nzbd2McazbPkEKxb8XyNfj2AyFrilnM7fEMTdbc7JOkHn54vI2kV/HseHDSCwbzHa8HMfcbM3JOkGCRrv54mZ572TE2LwU+ko5m4lVTrGB08RErBQkjre7K/SWcjazpol7gUuPQ8BKQVK3ekdoi24WSGtMdsWuIZFFPHkxJt3YKw0rBRn5M6tQvEUgsXhASYGby9n0tfHbHszIXkF6+hZI1f8tBM29tUOxHTUsLF2Z3s7tGD8C1goStCKZ71vhiH9fM9viQ/6qku18oJk5cO39E7BakPck8b7hCK5pxibhhXkzqNe3pvWCYK067iHe4yLS2OcwVB8rbUv/OdaKX1/LGN1IAhSkCYdXA/hvf3fLZytXLa40stlcq34CFGSUWYN+/kCBO8tbOy/izx/Uv1mbMYKCjKGe3FC8UlTWh32onKpWAeeqcq6zuxmN5pqTI0BBxuHWXti8tBXV61RxwVSfPlTosKjcWYXctD3X2Tu5NnFUswhQkAnIv/+N+9+J4nyIfKSuJileV8FdUkV36cr063WNZXBsCFAQk1aoSmpD7/E+cI4oPiXQJCCuAq4IFIoKoGUVKaviaV910/auzM9NpmZMvAlQkHj3h9k1mQAFaXIDpvvybk/fkfB1IXz/SIgcCWARVBcBskigiw54QIbqFhUERzH1+qr9IlKCyNt+Tbbp7LZnt1+ysNRMRhSkmfSn2drBjw61OMMnOIpPQuWExvyuo76sKk8AeE4d/Npvnf18I6WhINNskzY03Tt+N9cdHDwFgtNE9RSILG/o+vtfzFPo46qJR5ya/2iUN3pSkJh0PC5pBH8ySc1fqdCz43r6y1hWqnhcBf9amVXbiIuXDYbJkoKESXOaztXe078sURteKYq/FpFjp2kZQdo7Fbqx5uOusD5FpCDTeDdMJfX2npcPbq05FwIIjhk6bipzxXKsoqiit9Xa5mycyjULBYlld6NLyi30nSnwgx8MPS26VeI1swJ5qeJrk/nCloLEq5eRZZPK954O0XUz8t3CkJoCX9XdLbfUcxc1BTGEO13DFnT3nZqQ2lcgcvx0rSHMvBUYUMEVldXpO03mnTGCBL8cVU0412+/fIlnUvhMjxl5nBi1NRRj/E6Xsmkx2QMzR5CCp0HBPvSGqjjftfUIHTfvZQH9UtwOxjPZjI2MsVaQUciquKPa0nLT4KrFLzUSfDPWGrndo+qvhuglAjm4GTlMtzWtF+T3ougTvoNbB1Znmnp6SRQbyO3uOwPiXyaCs6KYfybPSUHGdlf1JYV8Z9iRe6fzn1/zN2z+REJrZ0H1PP4ZNXmFKcgE7BT4LwAPqepPKrnMc5PH3JiRwSdRjvhnC3A2BEc0ZtWZvQoFMe2v4k0FHoUjDw4D/xGHdxe3sPkPRWunKvQzAjkZgjmm5TDOjAAFMeP0gShV9ELwUwheUOA3Q9VZxZ1XHLllktNNOGz+ba+lZNfQx8XxPybQ5YAcA8XRIkhGsR7n/D0BChLmblDdoSLB9ytFgXo+5G2olMTxS4BTlppWdums8s62lgpWfWRn8NyE04Jka62ahEpSHSTh+wsgkhTFhyH4I1V8TASHhJkm5zInQEHMWTHSQgIUxMKms2RzAhTEnBUjLSRAQSxsOks2J0BBzFkx0kICFMTCprNkcwIUxJwVIy0kQEEsbDpLNidAQcxZMdJCAhTEwqazZHMCFMScFSMtJEBBLGw6SzYnQEHMWTHSQgIUxMKms2RzAhTEnBUjLSRAQSxsOks2J0BBzFkx0kICFMTCprNkcwIUxJwVIy0kQEEsbDpLNidAQcxZMdJCAhTEwqazZHMCFMScFSMtJEBBLGw6SzYnQEHMWTHSQgIUxMKms2RzAhTEnBUjLSRAQSxsOks2J0BBzFkx0kICFMTCprNkcwIUxJwVIy0kQEEsbDpLNidAQcxZMdJCAhTEwqazZHMCFMScFSMtJEBBLGw6SzYnQEHMWTHSQgIUxMKms2RzAhTEnBUjLSRAQSxsOks2J0BBzFkx0kICFMTCprNkcwIUxJwVIy0kQEEsbDpLNidAQcxZMdJCAhTEwqazZHMCFMScFSMtJEBBLGw6SzYnQEHMWTHSQgIUxMKms2RzAhTEnBUjLSRAQSxsOks2J0BBzFkx0kICFMTCprNkcwIUxJwVIy0kQEEsbDpLNidAQcxZMdJCAhTEwqazZHMCFMScFSMtJEBBLGw6SzYnQEHMWTHSQgL2CZIv7oDIXAt7zZLrJaC6o5TLtJsMcwteVYCESaxJjKQKnpoEmsbUYXqvAEtM52WcxQQUxVIuvdSEwIwRJJX3NkGw0qRoxthNQFV/UM5lzjehMGMESRaKX3Agt5sUzRi7CSj0gnI2c7cJhRkjCNa/Nic1+90+QA43KZwxdhJQ1f7yIcPLcO5Hh0wIzBxBALgbip8TlR+bFM4YOwnUfOczA11LHjOtPuxr6tAv0ne3Jg5759KON00LcvPFdSLyZdN4xtlDQKFrytnMLaYVH9TzyuGza8NbTONN4kIXxHcSx1Yu7/gfk8VHYyhJPbRmfqwqfIheW48cAZUF3d4fJxw8Eyah0AVRxV+Wc+m6/2xKFnrPdlQ3QHBYmAVyrulFILjm8CVx2UB2yaP1Zp7M961wxL+v3nETxUchSKGcS+cmlWTPloPc2jsroHoGIMcIsAiC+ZOai4OmBQEFBqDaL5BfQfBvpWx602QTT+W92yC4eLLjxxsXuiBQ3VLKZf4gzCQ5FwmYEHDzxbdE5EMmsaYx4QsCoKY4bSCX/nfTJBhHAlMlkOz2znIcPDDVecaOj0QQhW4ub00vxVqphp0w5yOBDxC458U296224NalhWHTiUSQIEkfekMlm1kXdsKcjwTGEnDzvTeL6JooyEQmyHsf1SVOKmc7nowicc5JAgEBt7vvDHH8h6KiEZkgQcKq+rZqy3GVro5XoyqA89pLoL2nf1lrbfgXgBjdCj8ZUpEKMiqJqPxFqSv99GQS5BgSGI9AMt97sgN9IOqvASIXZLQ4X/WLlVzm22w3CUyVQLLg/YMD3DjVeUzGN0yQkXcT6PMq8reV1elnTZJjDAnsTcAtbD5RUP0eIEYPT4VBr6GCjCaswLOAPiYijyrkjaEWZ1s9NziGUTjniDeBufn+w9pED4VUj4Qvpwn0VIgsb3TWTRGk0UVyPRKYLAEKMllyHGcFAXELxbcFkrKiWhZJAnUQUOhbwTvIiwCOrmMcQ0nACgKqeEFS+eKjEDnViopZJAnUR+ARieIe+vpyYDQJxJOAAhtk5Ek+6P3xTJFZkUDzCKjvnCno0dZUtXcAgjnNS4Urk0DcCOhgaWs6KUFabr54t4icF7cUmQ8JNJHA90vZ9EUjgiTzxWNF5FcCjPyfLxKwmUDwqEZVneWDXUuKe4RI5Yv3QWSFzWBYOwkEBBS4s5xNXxj8e48g8/LF5a0iL/JdhJvEZgIK1HaJv+jd1Uvf2EeQ969F1ojIzTYDYu12E/AFF1dWp/ccqv6Baw63UOwRyGV2Y2L1dhLQdaVs5oa9ax/3opyfatm5PWyuOvhSsJxNZ8cy2O+nVsl88QYRuZHXJDZvm5lfe3DNoarX7O9p1wk/1k0VvHOgejtE5s18VKzQNgLBoSK+JP5monOAD/i9R3vPywe31OQrULlEBI5tEFnvzCOg0CFRyaOGtaUr09snqvCAgowOTnV7H4XgaoWeFfb5pzOvBawolgRUt6jIj1Ravl5ZvfgVkxyNBdl7svndxeMdB38mKssAdIiM/FrtoSYLMoYEGkJA8aYKeqHog+j/Ai2PlLMdz9e79v8D/NCwVxBYBl8AAAAASUVORK5CYII=)'> </div>`)
                    .css('width',this.width).css('height',this.height)
                    .css('z-index',this.zIndex)
                    .html(`<div class='absolute-center text-shadow text-white' style='padding-top:10px;'>${this.text}</div>`)
                    .on('click',function(e){
                        that.handleClick(e)
                    })
                this.dom.appendTo($('.canvas-content'))
                this.pz = this.dom.panzoom({
                    startTransform: 'scale(1)',
                    increment: 0.2,
                    contain:true,
                    minScale: 0.4,
                    disableZoom: true,
                })
                
            }
            set width(val){

                if(val!=='auto'){
                    $('.imgVar-palette').find('.imgVar-width').val(val).end()
                    .find('.imgVar-width-info').text(val)
                    
                }
                this.dom && this.dom.css('width',val + 'px')
                           
                this._width = val
            }
            get width(){
                return this._width;
            }
            set height(val){

                if(val!=='auto'){
                    $('.imgVar-palette').find('.imgVar-height').val(val).end()
                    .find('.imgVar-height-info').text(val)
                    
                }
                this.dom && this.dom.css('height',val + 'px')
                           
                this._height = val
            }
            get height(){
                return this._height;
            }
        } 

        class Txt extends ele{
            constructor(text='点击添加文本信息',width=200,height=30){
                super()
                this.type='txt'
                this.text = text
                this.width = width
                this.height = height
                this.fontStyle = 'normal'
                this.fontVariant = 'normal'
                this.fontWeight = 700
                this.lineHeight = 1.24 
                this.fontSize = 20
                this.fontFamily = "Microsoft Yahei"
                this.init()
            }
            init(){
                let that = this
                this.dom = $(`<div class='bgi-normal position-absolute ' style='overflow:hidden;text-align:left'>${this.text} </div>`)
                    .css('width',this.width).css('height',this.height)
                    .css('z-index',this.zIndex)
                    .on('click',function(e){
                        that.handleClick(e)
                    })
                this.setFont();
                console.log('font',this.dom.css('font'))
                this.dom.appendTo($('.canvas-content'))
                this.pz = this.dom.panzoom({
                      startTransform: 'scale(1)',
                      increment: 0.2,
                      contain:true,
                      minScale: 0.4,
                      disableZoom: true,
                })
            }
            
            set color(val){
                this.dom && this.dom.css('color',val)
                this._color = val

            }
            get color(){
                return this._color
            }
            set width(val){

                if(val!=='auto'){
                    $('.txt-palette').find('.txt-width').val(val).end()
                    .find('.txt-width-info').text(val)
                    
                }
                this.dom && this.dom.css('width',val + 'px')
                           
                this._width = val
            }
            get width(){
                return this._width;
            }
            set height(val){

                if(val!=='auto'){
                    $('.txt-palette').find('.txt-height').val(val).end()
                    .find('.txt-height-info').text(val)
                    
                }
                this.dom && this.dom.css('height',val + 'px')
                           
                this._height = val
            }
            get height(){
                return this._height;
            }
            set lineHeight(val){

                if(val!=='auto'){
                    $('.txt-palette').find('.txt-lineHeight').val(val).end()
                    .find('.txt-lineHeight-info').text(val)
                    
                }
                this.dom && this.dom.css('line-height',val)
                           
                this._lineHeight = val
            }
            get lineHeight(){
                return this._lineHeight;
            }
            set fontWeight(val){

                if(val!=='auto'){
                    $('.txt-palette').find('.txt-fontWeight').val(val).end()
                    .find('.txt-fontWeight-info').text(val)
                    
                }
                this.dom && this.dom.css('font-weight',val)
                           
                this._fontWeight = val
            }
            get fontWeight(){
                return this._fontWeight;
            }
            set fontFamily(val){

                this.dom && this.dom.css('font-family',val)
                           
                this._fontFamily = val
            }
            get fontFamily(){
                return this._fontFamily;
            }
            
            
            fontPlus(){
                this.fontSize += 1
                this.setFont()
            }
            fontMinus(){
                this.fontSize = Math.max(this.fontSize-1,12)
                this.setFont()
            }
            setFont(){
                console.log('ft',`${this.fontStyle} ${this.fontVariant} ${this.fontWeight} ${this.fontSize}/${this.lineHeight} ${this.fontFamily}`)
                this.dom.css({
                    "font-style":this.fontStyle,
                    "font-variant":this.fontVariant,
                    "font-weight":this.fontWeight,
                    "font-size":this.fontSize,
                    "line-height":this.lineHeight,
                    "font-family":this.fontFamily
                })

            }

        }
        var canvasW,
            canvasH,
            canvasBG,
            canvasM = 60,
            canvasR=12;
      
        $(function(){
            

            const $widthInput = $("input[name='width']")
            const $heightInput = $("input[name='height']")
            const $imgInput = $("input[name='img-select']")
            const $colorInput = $("input[name='color-select']")
            const $bgImgInput = $("input[name='bgImg-select']")
            const $bgColorInput = $("input[name='bgColor-select']")
            const $canvas = $('.canvas-content').css('border-radius',canvasR)
            const $canvasContainer = $('.canvas-container')
            $('.shuffer-canvas').on('click',function(){
                $canvas.toggleClass('real-view')
                $canvasContainer.toggle()
                setCurrent(null)
            })

            $('.radius-plus').on('click',function(){
                canvasR = Math.min(canvasW/2,canvasH/2,canvasR+1)
                console.log(canvasR)
                $canvas.css('border-radius',canvasR)
            })
            $('.radius-minus').on('click',function(){
                canvasR = Math.max(0,canvasR-1)
                $canvas.css('border-radius',canvasR)
            })

            $('.link-palette').find('ul').html(function(){

                return linkDic.map(item=>{
                 return item.type=='img'?`<li data-type='${item.type}' class='py-2 m-0 border-top border-gray-800'>
                            <a class='link-img w-100' data-key='${item.key}' style='overflow:hidden;text-align:left'>
                                <i class='iconfont'> &#xe610; </i>
                                <span class='ml-4' style="font-size: 0.8em;">
                                    ${item.key}
                                </span>
                            </a>
                        </li>`: `<li data-type='${item.type}' class='py-2 m-0 border-top border-gray-800'>
                            <a class='link-txt w-100' data-key='${item.key}' style='overflow:hidden;text-align:left'>
                                <i class='iconfont'> &#xe89b; </i>
                                <span class='ml-4' style="font-size: 0.8em;">
                                   ${item.key}
                                </span>
                            </a>
                        </li>` 
                }).join('')
            })

            $("input[type='range']").on('change',function(){
                let $this = $(this)
                var value = $this.val()/ Number($this.prop('max')) * 100;
                var valStr = value + "% 100%";
                $this.css({
                  "background-size": valStr
                })
               
            })
            $("input[name='width'],input[name='height']").on('change',function(){
                canvasW = Number($widthInput.val())
                canvasH = Number($heightInput.val())
                $canvas.css({'width':canvasW,'height':canvasH}) 
                $canvasContainer.css({'width':canvasW+canvasM,'height':canvasH+canvasM})

                $('.txt-width,.imgVar-width').prop('max',canvasW)
                $('.txt-height,.imgVar-height').prop('max',canvasH)
            }).trigger('change')
            
            $imgInput.on('change',function(e){
              if(e.target.files[0])
             createObjectURL(e.target.files[0]).then(url=>{
              var $fakeImg = $(new Image())
              $fakeImg.prop('src',url);
              $fakeImg.one('load',function(){
                // 获取了url width height 就可以 插入一个 img 对象了
                let width = this.width 
                let height = this.height
                var maxScale;
                var ratio = width/height
                // 宽高比 大 按宽计算
                if(ratio >= canvasW/canvasH){
                   
                    width = Math.min(canvasW*0.6,width) 
                    height = width/ratio
                    maxScale = canvasW/width
                   
                }else{
                    height = Math.min(canvasH*0.6,height) 
                    width = height*ratio
                    maxScale = canvasH/height
                }
                let newEle = new Img(url,width,height,maxScale)
                elementArr.push(newEle)
                setCurrent(newEle)
                // 生成完成后 将 $imgInput清空
                $imgInput.val("")
               })
                
             })
        
            })
            $bgImgInput.on('change',function(e){
              if(e.target.files[0])
               createObjectURL(e.target.files[0]).then(url=>{
                  canvasBG = url
                  $canvas.css('background-image',`url(${url})`)
                    
               })
            })
            $colorInput.on('change',function(e){
                let $this = $(this)
                currentElement.color = $this.val();
            })
            $bgColorInput.on('change',function(e){
                let $this = $(this)
                $canvas.css('background-color',$this.val())
            })
            $('.tool-bar').on('click','.add-img,.add-txt',function(){
               //  ...
            }).on('click','.add-img',function(){       // 增加元素 菜单组
                $imgInput[0].click();
            }).on('click','.add-linkImg',function(){
                $('.link-palette').attr('data-type','img').show()
            }).on('click','.add-txt',function(){
                let newEle = new Txt()
                elementArr.push(newEle)
                setCurrent(newEle)
            }).on('click','.add-bgImg',function(){
                $bgImgInput[0].click()
            }).on('click','.add-bgColor',function(){
                $bgColorInput[0].click()
            }).on('click','.img-scale',function(){     // 图片元素 编辑菜单组
                let $this = $(this)
                let type = $this.attr('data-type')
                if(type=='plus'){
                    currentElement.dom.panzoom("zoom")
                }else{
                    currentElement.dom.panzoom("zoom",true)
                }
            }).on('click','.align-left',function(){     //  排列组合操作组
                var criteria;
                for(el of elementGroup){
                    if(criteria){
                        let dimension = el.getDimension();
                        let matrix = el.getMatrix()
                        let martix_4 = criteria - dimension.width * (1-matrix[0])/2;
                        el.dom.panzoom('pan',martix_4,matrix[5])
                    }else{
                        criteria = el.getDimension().x
                    }
                }
            }).on('click','.align-right',function(){     //  排列组合操作组
                var criteria;
                for(el of elementGroup){
                    if(criteria){
                        let dimension = el.getDimension();
                        let matrix = el.getMatrix()
                        let martix_4 = criteria - dimension.width * (1-matrix[0])/2 - dimension.width;
                        el.dom.panzoom('pan',martix_4,matrix[5])
                    }else{
                        let dimension = el.getDimension()
                        criteria = dimension.x + dimension.width
                    }
                }
            }).on('click','.align-top',function(){     //  排列组合操作组
                var criteria;
                for(el of elementGroup){
                    if(criteria){
                        let dimension = el.getDimension();
                        let matrix = el.getMatrix()
                        let martix_5 = criteria - dimension.height * (1-matrix[3])/2;
                        el.dom.panzoom('pan',matrix[4],martix_5)
                    }else{
                        criteria = el.getDimension().y
                    }
                }
            }).on('click','.align-bottom',function(){     //  排列组合操作组
                var criteria;
                for(el of elementGroup){
                    if(criteria){
                        let dimension = el.getDimension();
                        let matrix = el.getMatrix()
                        let martix_5 = criteria - dimension.height * (1-matrix[3])/2 -dimension.height;
                        el.dom.panzoom('pan',matrix[4],martix_5)
                    }else{
                        let dimension = el.getDimension()
                        criteria = dimension.y + dimension.height
                    }
                }
            }).on('click','.txt-plus',function(){      // 文字元素 编辑菜单组
                currentElement.fontPlus()
            }).on('click','.txt-minus',function(){
                currentElement.fontMinus()
            }).on('click','.txt-color',function(){
                $colorInput[0].click();
            }).on('click','.bg-delete',function(){     // 删除 操作 菜单组
                canvasBG = '';
                $canvas.css('background-image','none')
                        .css('background-color','#fff')
            }).on('click','.ele-delete',function(){
                if(currentElement) {
                    currentElement.remove()
                }else if(elementGroup.size>0){
                    for(let ele of elementGroup){
                        ele.remove()
                        elementGroup.delete(ele)
                    }
                }else{
                    alert('请先选择要删除的文字或图片')
                }
            }).on('click','.ele-layer',function(){
                currentElement ? currentElement.toLayerBottom():alert('请先选择要置于底层的文字或图片')
            }).on('click','.ele-link',function(){
                currentElement ? $('.link-palette').show():alert('请先选择要填充链接内容的文字或图片')
            })

            $('.link-palette').on('click','.link-img',function(){
                let newEle = new ImageVar($(this).attr('data-key'),200,200,canvasW,canvasH)
                elementArr.push(newEle)
                $('.link-palette').hide()
                newEle.focus()

            }).on('click','.link-txt',function(){
                currentElement.link($(this).attr('data-key'))
                $('.link-palette').hide()

            })

            var selectionStart = 0;
            var prev_length = 0;
            $('.txt-palette').on('input','.txt-text',function(){
                let $this= $(this)
                console.log($this.val())
                currentElement.text = $this.val().replace(/ /g,'&nbsp;').replace(/\n/g,'<br/>')
            }).on('change','.txt-width',function(){
                let $this= $(this)
                currentElement.width = $this.val()
            }).on('change','.txt-height',function(){
                let $this= $(this)
                currentElement.height = $this.val()
            }).on('change','.txt-lineHeight',function(){
                let $this= $(this)
                currentElement.lineHeight = $this.val()
            }).on('change','.txt-fontWeight',function(){
                let $this= $(this)
                currentElement.fontWeight = $this.val()
            }).on('click','.link-txt',function(){
                $('.link-palette').attr('data-type','txt').show()
            }).on('change','.txt-fontFamily',function(){
               let $this= $(this)

                currentElement.fontFamily = $this.val()
            }).find('.txt-fontFamily').html(function(){
                return supportFontFamily.map(item=>{
                    return `<option value='${item.en}' style='font-family:${item.en}'>${item.ch}</option>`
                }).join('')
            }).end()


            $('.imgVar-palette').on('change','.imgVar-width',function(){
                let $this= $(this)
                currentElement.width = $this.val()
            }).on('change','.imgVar-height',function(){
                let $this= $(this)
                currentElement.height = $this.val()
            })
            //刷新位置信息
            const positionInfo = $('.position-info')
            setInterval(function(){
                if(currentElement){
                  let dimension = currentElement.getDimension()
                  //显示尺寸 x:${dimension.x.toFixed(2)}px y:${dimension.y.toFixed(2)}px\
                    // width:${dimension.width.toFixed(2)}px height:${dimension.height.toFixed(2)}px\
                  positionInfo.html(`&nbsp;
                    实际尺寸 x:${(dimension.x*0.1).toFixed(2)}mm&nbsp;&nbsp;y:${(dimension.y*0.1).toFixed(2)}mm&nbsp;&nbsp;\
                    width:${(dimension.width*0.1).toFixed(2)}mm&nbsp;&nbsp;height:${(dimension.height*0.1).toFixed(2)}mm&nbsp;\
                    `)
                }else{
                    positionInfo.html('')
                }
            },60);
            {
               //获取div，向里面添加svg
                var svg = d3.select(".canvas-container")
                .append("svg:svg")//在“container”中插入svg
                .attr("width", canvasW + canvasM)//设置svg的宽度
                .attr("height", canvasH + canvasM)//设置svg的高度
                .attr("fill",'#fff')
                .append('rect')
                .attr("width", canvasW + canvasM)
                .attr("height", canvasH + canvasM)
                .attr("fill",'#212529')

                //添加g元素
                var g = d3.select("svg")
                .append("g")
                .attr("transform","translate("+ canvasM/2+","+canvasM/2+")") 

                var scale_x = d3.scaleLinear()//把曲线沿x轴按比例放大
                .domain([0, canvasW/100])
                .range([0, canvasW])
                var scale_y = d3.scaleLinear()//把曲线沿y轴按比例放大
                .domain([0, canvasH/100])
                .range([0,canvasH])

                var x_axis = d3.axisTop(scale_x).tickArguments([Math.round(canvasW/10)]).tickSize(10),
                y_axis = d3.axisLeft(scale_y).tickArguments([Math.round(canvasH/10)]).tickSize(10)

                var ax_x = g.append("g")
                .call(x_axis).attr('stroke','#fff')

                ax_x.selectAll('line').attr('stroke','#fff').attr('y2',function(d){
                     return Math.floor(d) == d ? '-10' :'-4'
                })
                
                ax_x.selectAll('text').html(function(d){
                    return Math.floor(d) == d ? d :''
                })

                var ax_y = g.append("g")
                .call(y_axis)
                .attr('stroke','#fff')


                ax_y.selectAll('line').attr('stroke','#fff').attr('x2',function(d){
                     return Math.floor(d) == d ? '-10' :'-4'
                })
                ax_y.selectAll('text').html(function(d){
                    return Math.floor(d) == d ? d :''
                })
                ax_y.append("text")
                .text("mm")
                .attr("transform","translate(-6,-5)")
                .attr("stroke","#fff")
                .attr("text-anchor","end")//字体尾部对齐
                .attr("dy","-1em")//沿y轴平移一个字体的大小
            }
            realize(fakeMsg)
            $(document).on('keydown',function(e){
                if(e.ctrlKey && e.keyCode ){
                    // 上
                    if(currentElement){
                        if(e.keyCode == 40){
                           currentElement.dom.panzoom('pan',0,1,{relative:true})

                        }
                        // 右
                        if(e.keyCode == 39){
                            currentElement.dom.panzoom('pan',1,0,{relative:true})
                        }
                        //下
                        if(e.keyCode == 38){
                            currentElement.dom.panzoom('pan',0,-1,{relative:true})
                        }
                        //左
                        if(e.keyCode == 37){
                            currentElement.dom.panzoom('pan',-1,0,{relative:true})
                        }
                    }else if(elementGroup.size>0){
                        if(e.keyCode == 40){
                           for (let ele of elementGroup){
                               ele.dom.panzoom('pan',0,1,{relative:true})
                           }
                        }
                        // 右
                        if(e.keyCode == 39){
                            for (let ele of elementGroup){
                               ele.dom.panzoom('pan',1,0,{relative:true})
                            }
                        }
                        //下
                        if(e.keyCode == 38){
                             for (let ele of elementGroup){
                               ele.dom.panzoom('pan',0,-1,{relative:true})
                            }
                        }
                        //左
                        if(e.keyCode == 37){
                             for (let ele of elementGroup){
                               ele.dom.panzoom('pan',-1,0,{relative:true})
                            }
                        }
                    }
                }
                if(e.keyCode == 46){
                    if(currentElement) {
                        currentElement.remove()
                    }else if(elementGroup.size>0){
                        for(let ele of elementGroup){
                            ele.remove()
                            elementGroup.delete(ele)
                        }
                    }else{
                        alert('请先选择要删除的文字或图片')
                    }
                }

            })
        })  
        function serialize(){
            return {
                "cardname":"杭州市社保卡",
                width:canvasW,
                height:canvasH,
                backgroundImg:canvasBG,
                context:elementArr.map(item=>item.serialize())
            }
        }
        function realize(obj){
            canvasBG = obj.backgroundImg
            canvasW = obj.width
            canvasH = obj.height
            $('.main-title').text(obj.cardname)
            $('.canvas-content').css('border-radius',obj.borderRadius)
            .css('background-image',`url(${obj.backgroundImg})`)
            $("input[name='width']").val(obj.width).trigger('change')
            $("input[name='height']").val(obj.height).trigger('change')
            obj.context.map(item=>{
                var newEle;
                if(item.type=='img'){
                    let width = item.width 
                    let height = item.height
                    var maxScale;
                    var ratio = width/height
                    // 宽高比 大 按宽计算
                    if(ratio >= canvasW/canvasH){
                   
                        width = Math.min(canvasW*0.6,width) 
                        height = width/ratio
                        maxScale = canvasW/width
                       
                    }else{
                        height = Math.min(canvasH*0.6,height) 
                        width = height*ratio
                        maxScale = canvasH/height
                    }
                     newEle = new Img(item.backgroundImg,width,height,maxScale)
                    
                   
                }else if(item.type=='txt'){
                    newEle = new Txt()
                    newEle.text = item.value
                    newEle.width = item.width
                    newEle.height = item.height
                    newEle.color = item.color

                    newEle.fontSize = item.fontSize
                    newEle.fontFamily = item.fontFamily
                    newEle.fontWeight = item.fontWeight
                    newEle.lineHeight = item.lineHeight
                   
                }else if(item.type=='image-var'){
                    newEle = new ImageVar(item.src,200,200,canvasW,canvasH)
                    newEle.width = item.width
                    newEle.height = item.height
                    
                }
                newEle.dom.panzoom('pan',item.x,item.y)
                elementArr.push(newEle)
            })
        }

        function setCurrent(ele){
            if(ele){
                elementArr.map(item => item.blur())
                ele.focus()
            }else{
                currentElement&&currentElement.blur();
                currentElement = null;
                $('.tool-bar').attr('data-current','')
            }
        }

        function createObjectURL(blob){
            return new Promise(function(res,rej){
               var a = new FileReader();
               a.onload = function(e) {res(e.target.result)};
               a.readAsDataURL(blob);
            })

           // 转成 Object URl
               if(window.URL){
                   return window.URL.createObjectURL(blob);
               }else if(window.webkitURL){
                   return window.webkitURL.createObjectURL(blob);
               }
                   return null;
        }


    </script>
</body>

</html>